# OTA on Ubuntu

## Build

1. 首先将该项目clone至本地

```git
git clone git@gitlab.eduxiji.net:thf5000y2k/project325618-86900.git
```

2. clone后使用qtcreator打开工程文件进行build。

   · `ota_server.pro`：编译可得到 otaserver 服务器程序

   · `ota_update.pro`：编译可得到update升级程序

   · `ota_demo.pro`：编译后可得到app主程序

## 测试样例

### 服务端

​	在`test/ota/server/`下有预先设定好的`strategy.json`文件、RSA签名的密钥文件、SSL证书以及预编译好了的0.0.1~0.0.4四个版本的demo。服务器编译完成后在此目录下./otaserver` 即可运行。服务器完整包由管理员添加并由程序监听，服务器完整包添加方法：

​	在服务器运行后，可以手动将 `test/ota/server/` 目录下 `0.0.1-0.0.4` 完整包文件夹依次添加到服务器运行目录。

​	第一次添加 `0.0.1` 时，服务器会提示管理员输入y/n表示是否生成差分包，第一次需要输入 `n`，之后每次添加一个目录管理员需要输入 `y` 或 `Y` 表明需要生成差分包。管理员每添加一个完整包文件夹时服务器就会将该新添加的版本号进行落盘，以便下次重启服务器时可以自动构建版本映射表(VersionMap)。

​	预先设定好的`strategy.json`文件规定如下：版本小于0.0.3则升级到0.0.3，版本大于0.0.3则回滚到0.0.3。

### 客户端

客户端可以编译 `ota_demo.pro` 和 `ota_update.pro` 工程文件以生成客户端测试程序和更新版本程序，最后会生成两个可执行文件： `app` 和 `update` 

`update` 作为app的更新模块，可以不依赖于app而独立执行。

`app` 参数如下

- -t 查看当前app输出内容
- -v 查看当前app版本的校验码
- -u 对当前app进行升级

当服务器对完整包初始化后，客户端可以通过 `./app -u` 进行升级或回滚，然后通过 `./app -v` 查看升级/回滚后的版本校验码。

## 升级(回滚)流程

1.客户端发送app信息

2.服务器根据客户端的信息选定目标版本，然后将相关信息返回给客户端。

3.如果升级(回滚)是可选的，则让客户端决定是否升级(回滚)，如果客户端拒绝升级(回滚)，则退出流程。

4.若升级回滚是强制的或客户端决定升级，则客户端会再发一个确认的信息给服务器。

5.服务器接收到确认信息后会根据确认信息中的"From"、"Destination"域中提取出版本信息并调用VersionMap的search方法进行查找。

6.服务器会通过search方法查找到的路径信息去找出相应差分包、升级后的版本校验码以及差分包签名，找到所有文件后放入同一目录下打包成.tar.gz发送给客户端。

7.客户端接收到.tar.gz文件后会将其解压至一临时目录，随后打开apply_log，按照apply_log中存储好了的信息进行逐包升级()：

​	① 对差分包进行签名的验证，如验证失败则升级(回滚)失败，返回错误信息以及当前版本号。

​	② 验证成功后则解压差分包至一临时路径，调用相关函数进行版本升级(回滚)，若升级失败则返回错误信息和当前版本号。

​	③ 升级(回滚)成功后则根据文件目录下的file_log对其记录了的文件求版本的校验码，与.tar.gz中存放的服务器端版本的校验码进行对比，如不一致则返回升级失败相关的提示信息。

8.升级(回滚)完成。
